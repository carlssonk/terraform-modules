name: Terraform Fix Operations

inputs:
  operation:
    type: string
    description: "Operation to perform: unlock or import"
    required: true
  environment:
    type: string
    description: "Target environment"
    required: true
  aws_region:
    type: string
    description: "AWS Region"
    required: true
  aws_account_id:
    type: string
    description: "AWS Account ID"
    required: true
  tf_root_directory:
    type: string
    description: "Terraform root directory (e.g., ./terraform/app/environments/staging-and-production)"
    required: true
  terraform_version:
    type: string
    description: "Terraform version to use"
    required: false
    default: "1.9.7"
  state_key:
    type: string
    description: "Terraform state file"
    required: false
    default: "terraform.tfstate"
  lock_id:
    type: string
    description: "Lock ID (required for unlock operation)"
    required: false
    default: ""
  import_address:
    type: string
    description: "Terraform resource address (required for import, e.g., aws_s3_bucket.example)"
    required: false
    default: ""
  import_id:
    type: string
    description: "AWS resource ID (required for import, e.g., bucket-name or arn:aws:...)"
    required: false
    default: ""

runs:
  using: 'composite'
  steps:
    - name: Validate unlock inputs
      if: inputs.operation == 'unlock'
      shell: bash
      run: |
        if [ -z "${{ inputs.lock_id }}" ]; then
          echo "âŒ Error: lock_id is required for unlock operation"
          exit 1
        fi
        echo "âœ“ Unlock operation validated"

    - name: Validate import inputs
      if: inputs.operation == 'import'
      shell: bash
      run: |
        if [ -z "${{ inputs.import_address }}" ] || [ -z "${{ inputs.import_id }}" ]; then
          echo "âŒ Error: import_address and import_id are required for import operation"
          exit 1
        fi
        echo "âœ“ Import operation validated"

    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS Credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::${{ inputs.aws_account_id }}:role/github-actions-cicd-role
        aws-region: ${{ inputs.aws_region }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ inputs.terraform_version }}

    - name: Terraform Init
      shell: bash
      run: |
        terraform init \
          -input=false \
          -backend-config="encrypt=true" \
          -backend-config="region=${{ inputs.aws_region }}" \
          -backend-config="bucket=terraform-state-${{ inputs.aws_account_id }}" \
          -backend-config="dynamodb_table=terraform-lock-table-${{ inputs.aws_account_id }}" \
          -backend-config="key=${{ inputs.state_key }}"
      working-directory: ${{ inputs.tf_root_directory }}

    - name: Unlock State
      if: inputs.operation == 'unlock'
      shell: bash
      run: |
        echo "ðŸ”“ Unlocking state with Lock ID: ${{ inputs.lock_id }}"
        terraform force-unlock -force "${{ inputs.lock_id }}"
        echo "âœ… State unlocked successfully"
      working-directory: ${{ inputs.tf_root_directory }}

    - name: Import Resource
      if: inputs.operation == 'import'
      shell: bash
      run: |
        echo "ðŸ“¥ Importing resource:"
        echo "  Address: ${{ inputs.import_address }}"
        echo "  ID: ${{ inputs.import_id }}"
        terraform import "${{ inputs.import_address }}" "${{ inputs.import_id }}"
        echo "âœ… Resource imported successfully"
      working-directory: ${{ inputs.tf_root_directory }}

    - name: Verify State
      shell: bash
      run: |
        echo "ðŸ” Verifying state..."
        terraform state list
        echo "âœ… State verification complete"
      working-directory: ${{ inputs.tf_root_directory }}

    - name: Summary
      if: always()
      shell: bash
      run: |
        echo "## ðŸ”§ Fix Operation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Operation**: ${{ inputs.operation }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- **State Key**: ${{ inputs.state_key }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Terraform Directory**: ${{ inputs.tf_root_directory }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ inputs.operation }}" = "unlock" ]; then
          echo "- **Lock ID**: ${{ inputs.lock_id }}" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ inputs.operation }}" = "import" ]; then
          echo "- **Resource Address**: ${{ inputs.import_address }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Resource ID**: ${{ inputs.import_id }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… Operation completed successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Operation failed" >> $GITHUB_STEP_SUMMARY
        fi
