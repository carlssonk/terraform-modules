name: Deploy Infrastructure

on:
  workflow_call:
    inputs:
      environment:
        type: string
        description: "Environment to deploy"
        required: true
      aws_region:
        type: string
        description: "AWS Region"
        required: true
      aws_account_id:
        type: string
        description: "AWS Account ID"
        required: true
      tf_root_directory:
        type: string
        description: "Terraform root directory (e.g., ./environments/production)"
        required: true
      terraform_version:
        type: string
        description: "Terraform version to use"
        required: false
        default: "1.9.7"
      state_key:
        type: string
        description: "Terraform state file"
        required: false
        default: "terraform.tfstate"
      action:
        type: string
        description: "Terraform action to perform: plan or apply"
        required: false
        default: "apply"
    secrets:
      CLOUDFLARE_API_TOKEN:
        required: false

concurrency:
  group: terraform-${{ inputs.environment }}-${{ inputs.state_key }}
  cancel-in-progress: false

env:
  TF_VAR_aws_region: ${{ inputs.aws_region }}
  TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}

jobs:
  terraform-deploy:
    name: ${{ inputs.action == 'plan' && 'Plan' || 'Deploy' }} Infrastructure - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    environment: ${{ inputs.environment }}
    permissions:
      id-token: write
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ inputs.aws_account_id }}:role/github-actions-cicd-role
          aws-region: ${{ inputs.aws_region }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ inputs.terraform_version || '1.9.7' }}

      - name: Terraform Init
        run: |
          terraform init \
            -input=false \
            -backend-config="encrypt=true" \
            -backend-config="region=${{ inputs.aws_region }}" \
            -backend-config="bucket=terraform-state-${{ inputs.aws_account_id }}" \
            -backend-config="dynamodb_table=terraform-lock-table-${{ inputs.aws_account_id }}" \
            -backend-config="key=${{ inputs.state_key }}"
        working-directory: ${{ inputs.tf_root_directory }}

      - name: Terraform Validate
        run: terraform validate
        working-directory: ${{ inputs.tf_root_directory }}

      - name: Terraform ${{ inputs.action == 'plan' && 'Plan' || 'Apply' }}
        run: |
          terraform workspace select -or-create ${{ inputs.environment }}
          
          # Check if tfvars file exists
          TFVARS_FILE="${{ inputs.environment }}.tfvars"
          VAR_FILE_FLAG=""
          if [ -f "$TFVARS_FILE" ]; then
            VAR_FILE_FLAG="-var-file=$TFVARS_FILE"
            echo "Using tfvars file: $TFVARS_FILE"
          else
            echo "No tfvars file found for ${{ inputs.environment }}"
          fi
          
          if [ "${{ inputs.action }}" = "plan" ]; then
            echo "Running terraform plan..."
            terraform plan $VAR_FILE_FLAG -no-color
          else
            echo "Running terraform apply..."
            terraform apply -auto-approve $VAR_FILE_FLAG -no-color
          fi
        working-directory: ${{ inputs.tf_root_directory }}

      - name: Terraform Output
        if: inputs.action == 'apply'
        run: terraform output -no-color
        working-directory: ${{ inputs.tf_root_directory }}
        continue-on-error: true